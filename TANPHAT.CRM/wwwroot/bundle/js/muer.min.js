(function(){app.controller("User.checkSchedule",["$scope","$rootScope","$state","viewModel","notificationService","userService","dayOfWeekVN","shiftStatus","$uibModal",function(n,t,i,r,u,f,e,o,s){function c(n){var t=moment(n,"YYYY-MM").format("YYYY-MM-01"),i=moment(n,"YYYY-MM").endOf("month").format("YYYY-MM-DD");return{startDate:t,endDate:i}}var h=angular.extend(this,r);n.$on("$locationChangeStart",function(n){var t=confirm("Dữ liệu có thể mất nếu bạn chưa lưu lại!!!");t||n.preventDefault()});h.isSaving=!1;h.month=h.params.distributeMonth;h.thisMonth=moment(h.month,"YYYY-MM").format("MM/YYYY");h.listMonth=[];h.listStatus=angular.copy(o);h.isCanChangeData=t.sessionInfo.UserTitleId==1||(currentEvi!="pro"?!0:t.sessionInfo.UserTitleId==6);h.isCanFixData=t.sessionInfo.UserTitleId==1||currentEvi!="pro";h.isCheckMonth=function(n={},t,i=false){var r=t==1?"13:30:00":"23:59:59";return i?h.isCanFixData||moment().diff(moment(h.month+"-01 "+r,"YYYY-MM-01 HH:mm:ss"))<0:h.isCanFixData||moment().diff(moment(n.DistributeDate+" "+r,"YYYY-MM-DD HH:mm:ss"))<0};h.objStaff={};h.objStatus={};h.listStaff.forEach(function(n){h.objStaff[n.Id.toString()]=n.Name});h.listStatus.forEach(function(n){h.objStatus[n.Id.toString()]=n.SName});h.distributeInfo={ActionBy:t.sessionInfo.UserId,ActionByName:t.sessionInfo.FullName+" ("+t.sessionInfo.UserTitleName+")",Month:h.params.distributeMonth};h.dayOfWeekVN=angular.copy(e);h.loadData=function(){h.params.distributeMonth=moment(h.month).format("YYYY-MM");i.go(i.current,h.params,{reload:!1,notify:!0})};h.getSaveData=function(){var n=[];return h.listSalePoint.forEach(function(t){var i={SalePointId:t.Id};i.MainShift={inputShift_1:t.inputShift_1,inputShift_2:t.inputShift_2,inputIntern:t.inputIntern};i.ShiftData=[];t.listMonth.forEach(function(n){var u,r,f;for(let e=1;e<=2;e++)u=null,r=n["objShift"+e].isShift1?1:2,u=n["Shift"+r]?n["Shift"+r]:t["inputShift_"+r],u&&(f={ShiftId:e,UserId:u,DistributeDate:n.DistributeDate,ShiftTypeId:n["ShiftTypeId"+r],Note:n["Note"+r]},i.ShiftData.push(f))});i.ShiftData.length>0&&n.push(i)}),n};h.getShiftMain=function(){var n=[],t=[];return h.listSalePoint.forEach(function(t){try{t.ShiftMain.inputShift_1&&n.push(t.ShiftMain.inputShift_1)}catch(i){}try{t.ShiftMain.inputShift_2&&n.push(t.ShiftMain.inputShift_2)}catch(i){}try{t.ShiftMain.inputIntern&&n.push(t.ShiftMain.inputIntern)}catch(i){}}),$.each(n,function(n,i){$.inArray(i,t)===-1&&t.push(i)}),t};h.checkNotIncludes=function(n,t){return!t.includes(n)};h.getExtendUser=function(){var n=[],t=[];return h.fullListData.forEach(function(n){var i=n.ShiftData.filter(function(n){return h.checkNotIncludes(n.UserId,h.listMainShift)});i.length>0&&i.forEach(function(n){t.push(n.UserId)})}),$.each(t,function(t,i){$.inArray(i,n)===-1&&n.push(i)}),n};h.getMonthOfWork=function(n,t=true){var i=[],e=0,r,f,u;h.listMonth.forEach(function(n){i.push({Day:n.DistributeDate,Working:[]})});h.fullListData.forEach(function(t){var r=t.ShiftData.filter(function(i){if(i.UserId==n)return i.SalePointId=t.SalePointId,i.target=parseInt(i.DistributeDate.slice(8,10))-1,i});r.length>0&&(e+=r.length,r.forEach(function(n){i[n.target].Working.push(n)}))});r=i.filter(n=>n.Working.length==0).length;f=0;t&&(u=angular.copy(r),i.forEach(function(n){var t,i,r;if(n.Working.length>=2){t=n.Working;for(let n=1;n<t.length;n++)u>0?(t[n].ShiftTypeId=2,u--):(t[n].ShiftTypeId=3,f++),i=h.listSalePoint.filter(i=>i.Id==t[n].SalePointId)[0],r=i.listMonth[t[n].target]["objShift"+t[n].ShiftId].isShift1?1:2,i.listMonth[t[n].target]["ShiftTypeId"+r]=t[n].ShiftTypeId}}));h.listAttend.push({UserId:n,TotalShift:e,TotalAbsent:t?r:0,TotalMakeup:t?r-u:0,TotalOT:f,IsMainShift:t})};h.restartShiftType=function(){h.listSalePoint.forEach(function(n){n.listMonth.forEach(function(n){n.ShiftTypeId1=1;n.ShiftTypeId2=1})})};h.checkFullSchedule=function(){h.listAttend=[];h.restartShiftType();h.listMainShift=h.getShiftMain();h.fullListData=h.getSaveData();h.listExtend=h.getExtendUser();h.listMainShift.forEach(function(n){h.getMonthOfWork(n)});h.listExtend.forEach(function(n){h.getMonthOfWork(n,!1)})};h.openPopup=function(n,t={},i={}){var e=null,r=t["objShift"+n].isShift1?1:2,o,c,f;e=t["Shift"+r]?t["Shift"+r]:i["inputShift_"+r];o=angular.copy(h.listStaff);c=baseAppPath+"/user/views/modal/";f=s.open({templateUrl:c+"shiftDetail.html"+versionTemplate,controller:"User.shiftDetail as $vm",backdrop:"static",size:"md",windowClass:"remove-modal-footer",resolve:{viewModel:{userOnShift:{name:t.name,userId:e},note:t["Note"+r],shift:n,salePointId:i.Id,distributeDate:t.DistributeDate,listStaff:o,isIntern:!1}}});f.opened.then(function(){$(document).ready(function(){$(".modal-footer").addClass("remove-modal-footer")})});f.result.then(function(){},function(u){var f,e,o,s;if(typeof u=="object"){f=i.listMonth.findIndex(n=>n.DistributeDate==t.DistributeDate);for(let t=f;t<(u.isApplyAll?i.listMonth.length:f+1);t++)i.listMonth[t]["Shift"+r]=u.UserId,i.listMonth[t]["Note"+r]=u.Note,i.listMonth[t]["ShiftTypeId"+r]=u.ShiftTypeId,e=h.listStaff.filter(n=>n.Id==u.UserId),o=h.listStatus.filter(n=>n.Id==u.ShiftTypeId)[0],e.length>0?(i.listMonth[t]["objShift"+n].isChangeData=!0,i.listMonth[t]["objShift"+n].Name=e[0].Name):i.listMonth[t]["objShift"+n].Name="Không tìm thấy người dùng",n=n==1?2:1;s=i.listMonth.findIndex(n=>n.DistributeDate==t.DistributeDate);h.checkDupValueAll()}})};h.openDayOffLeader=function(n={}){console.log("model",n);var i=baseAppPath+"/user/views/modal/",t=s.open({templateUrl:i+"addLeaderOff.html"+versionTemplate,controller:"User.addLeaderOff as $vm",backdrop:"static",size:"md",windowClass:"remove-modal-footer",resolve:{viewModel:{date:n,listLeader:h.listLeader}}});t.opened.then(function(){$(document).ready(function(){$(".modal-footer").addClass("remove-modal-footer")})});t.result.then(function(){},function(t){typeof t=="object"&&(n=angular.extend(n,t))})};h.getIdTarget=function(n,t,i){var r=h.listSalePoint[n].listMonth[i]["objShift"+t].isShift1?1:2;return h.listSalePoint[n].listMonth[i]["Shift"+r]?h.listSalePoint[n].listMonth[i]["Shift"+r]:h.listSalePoint[n]["inputShift_"+r]?h.listSalePoint[n]["inputShift_"+r]:null};h.checkDupValue=function(n,t,i){var r=h.getIdTarget(n,t,i);if(r)for(let u=n+1;u<h.listSalePoint.length;u++)if(n!=u&&(UserId=h.getIdTarget(u,t,i),UserId&&UserId==r)){h.listSalePoint[u].listMonth[i]["objShift"+t].isDup=!0;h.listSalePoint[n].listMonth[i]["objShift"+t].isDup=!0;h.listDateInMonth[i].isDup=!0;h.totalDup++;break}};h.exec=function(n,t){for(let i=0;i<h.listSalePoint.length-1;i++)h.listSalePoint[i].listMonth[t]["objShift"+n].isDup=!1;for(let i=0;i<h.listSalePoint.length-1;i++)h.checkDupValue(i,n,t)};h.checkDupValueAll=function(){h.totalDup=0;var{endDate:n}=c(h.month),n=parseInt(n.slice(8,10));for(let t=0;t<n;t++){h.listDateInMonth[t].isDup=!1;for(let n=1;n<=2;n++)h.exec(n,t)}h.checkFullSchedule()};h.initData=function(){var u,f,t,n;for(h.listMonth=[],{startDate:u,endDate:f}=c(h.month),t=u;moment(t)<=moment(f);){var n=moment(t).format("YYYY-MM-DD"),i=h.listHoliday.filter(t=>moment(t.Date).format("YYYY-MM-DD")==n),r=!1;i&&i[0]&&(r=!0);h.listMonth.push({DistributeDate:n,IsChecked:!1,IsWeekEnd:moment(n).day()==0,DateName:h.dayOfWeekVN[moment(n).day()].SName,IsHoliday:r,Tooltip:r?i[0].DateName:""});t=moment(t).add(1,"day")}h.listEvent=[];h.listSalePoint.forEach(function(n){n.inputShift_1=null;n.inputShift_2=null;var t=angular.copy(h.listMonth);t.forEach(function(n,t){n.objShift1={};n.objShift2={};n.ShiftTypeId1=1;n.ShiftTypeId2=1;n.objShift1.isShift1=t%2==1;n.objShift2.isShift1=t%2==0});n.listMonth=t});h.listDistribute=h.listDistribute.filter(n=>n.IsActive==!0);n=Enumerable.From(h.listDistribute).GroupBy(function(n){return n.SalePointId}).Select(function(n){return{SalePointId:n.source[0].SalePointId,ShiftMain:n.source[0].ShiftMain,Data:n.source}}).ToArray();n.length>0&&n.forEach(function(n){var i=h.listSalePoint.findIndex(t=>t.Id===n.SalePointId),t=h.listSalePoint[i];n.ShiftMain&&(t.ShiftMain=JSON.parse(n.ShiftMain),t.inputShift_1=t.ShiftMain.inputShift_1,t.inputShift_2=t.ShiftMain.inputShift_2);n.Data.forEach(function(n){var f=t.listMonth.findIndex(t=>t.DistributeDate==moment(n.DistributeDate).format("YYYY-MM-DD")),i=t.listMonth[f],r=i["objShift"+n.ShiftId].isShift1?1:2,u,e;t["inputShift_"+r]!=n.UserId&&(i["Shift"+r]=n.UserId,i["ShiftTypeId"+r]=n.ShiftTypeId,i["Note"+r]=n.Note,u=h.listStaff.filter(t=>t.Id==n.UserId),e=h.listStatus.filter(t=>t.Id==n.ShiftTypeId)[0],u.length>0?(i["objShift"+n.ShiftId].isChangeData=!0,i["objShift"+n.ShiftId].Name=u[0].Name):i["objShift"+n.ShiftId].Name="Không tìm thấy người dùng")})});h.listDateInMonth=angular.copy(h.listMonth);h.listLeader&&h.listLeader.length>0&&h.listLeader.forEach(function(n){n.DataSearch=n.Name.toUnaccent()});h.listDateOff=angular.copy(h.listMonth);console.log(" vm.listDateOff ",h.listDateOff);h.listLeaderOff&&h.listLeaderOff.length>0&&h.listLeaderOff.forEach(function(n){var t=h.listDateOff.findIndex(t=>t.DistributeDate==moment(n.Date).format("YYYY-MM-DD"));n.Name=n.FullName;t>0&&(h.listDateOff[t]=angular.extend(h.listDateOff[t],n))});console.log(" vm.listDateOff1 ",h.listDateOff)};h.initData();h.checkDateDup=function(n){var t=!1;return h.listSalePoint.forEach(function(i){(i.listMonth[n].objShift1.isDup||i.listMonth[n].objShift2.isDup)&&(t=!0)}),t};h.checkCurrentDate=function(n){var t=moment().format("YYYY-MM-DD"),i=parseInt(t.slice(8))-1,r=t.slice(0,7);return n==i&&h.month==r?!0:!1};h.checkDupValueAll();h.save=function(){h.isSaving=!0;h.totalDup==0||currentEvi!="pro"?(h.listSave=h.getSaveData(),h.distributeInfo.DistributeData=JSON.stringify(h.listSave),h.distributeInfo.AttendanceData=JSON.stringify(h.listAttend),h.listSave.length==0?(setTimeout(function(){h.isSaving=!1;t.$apply(h.isSaving)},1e3),u.warning("Chưa có thông tin để lưu")):f.distributeShiftMonth(h.distributeInfo).then(function(n){n&&n.Id>0?setTimeout(function(){u.success(n.Message);i.reload();h.isSaving=!1},1e3):(h.isSaving=!1,u.error(n.Message))})):(setTimeout(function(){h.isSaving=!1;t.$apply(h.isSaving)},1e3),u.warning("Đang có trùng ca"))};$(document).ready(function(){$(".select2-drop").css("position","sticky");$(".tooltips").append("<span><\/span>");$(".tooltips").mouseenter(function(){$(this).find("span").empty().append($(this).attr("tooltip"))});setTimeout(function(){$(".table-responsive").animate({scrollLeft:(parseInt(moment().format("DD"))-1)*200},400)},500)});h.checkFullSchedule();h.clickMonth=function(n){h.month=moment().add(n,"month").format("YYYY-MM");h.loadData()}}])})(),function(){app.controller("User.checkScheduleIntern",["$scope","$rootScope","$state","viewModel","notificationService","userService","dayOfWeekVN","shiftStatus","$uibModal",function(n,t,i,r,u,f,e,o,s){function c(n){var t=moment(n,"YYYY-MM").format("YYYY-MM-01"),i=moment(n,"YYYY-MM").endOf("month").format("YYYY-MM-DD");return{startDate:t,endDate:i}}var h=angular.extend(this,r),l;h.isSaving=!1;l=["MM-YYYY","YYYY-MM"];n.$on("$locationChangeStart",function(n){var t=confirm("Dữ liệu có thể mất nếu bạn chưa lưu lại!!!");t||n.preventDefault()});h.month=h.params.distributeMonth;h.thisMonth=moment(h.month,"YYYY-MM").format("MM/YYYY");h.listMonth=[];h.listStatus=angular.copy(o);h.isCanChangeData=t.sessionInfo.UserTitleId==1||(currentEvi!="pro"?!0:t.sessionInfo.UserTitleId==6);h.isCanFixData=t.sessionInfo.UserTitleId==1||currentEvi!="pro";h.isCheckMonth=function(n={},t,i=false){var r=t==1?"13:30:00":"23:59:59";return i?h.isCanFixData||moment().diff(moment(h.month+"-01 "+r,"YYYY-MM-01 HH:mm:ss"))<0:h.isCanFixData||moment().diff(moment(n.DistributeDate+" "+r,"YYYY-MM-DD HH:mm:ss"))<0};h.objStaff={};h.objStatus={};h.listStaff.forEach(function(n){h.objStaff[n.Id.toString()]=n.Name});console.log("vm.listStaff",h.listStaff);console.log("vm.listSalePoint",h.listSalePoint);h.listStatus.forEach(function(n){h.objStatus[n.Id.toString()]=n.SName});h.distributeInfo={ActionBy:t.sessionInfo.UserId,ActionByName:t.sessionInfo.FullName+" ("+t.sessionInfo.UserTitleName+")",Month:h.params.distributeMonth};h.dayOfWeekVN=angular.copy(e);h.loadData=function(){h.params.distributeMonth=moment(h.month).format("YYYY-MM");i.go(i.current,h.params,{reload:!1,notify:!0})};h.getSaveData=function(){var n=[];return h.listSalePoint.forEach(function(t){var i={SalePointId:t.Id};i.MainShift={inputShift_1:t.inputShift_1,inputShift_2:t.inputShift_2,inputIntern:t.inputIntern};i.ShiftData=[];t.listMonth.forEach(function(n){var u,r,f;for(let e=1;e<=2;e++)u=null,r=n["objShift"+e].isShift1?1:2,u=n["Shift"+r]?n["Shift"+r]:t["inputShift_"+r],u&&(f={ShiftId:e,UserId:u,DistributeDate:n.DistributeDate,ShiftTypeId:n["ShiftTypeId"+r],Note:n["Note"+r]},i.ShiftData.push(f))});i.ShiftData.length>0&&n.push(i)}),n};h.getShiftMain=function(){var n=[],t=[];return h.listSalePoint.forEach(function(t){try{t.ShiftMain.inputShift_1&&n.push(t.ShiftMain.inputShift_1)}catch(i){}try{t.ShiftMain.inputShift_2&&n.push(t.ShiftMain.inputShift_2)}catch(i){}try{t.ShiftMain.inputIntern&&n.push(t.ShiftMain.inputIntern)}catch(i){}}),$.each(n,function(n,i){$.inArray(i,t)===-1&&t.push(i)}),t};h.checkNotIncludes=function(n,t){return!t.includes(n)};h.getExtendUser=function(){var n=[],t=[];return h.fullListData.forEach(function(n){var i=n.ShiftData.filter(function(n){return h.checkNotIncludes(n.UserId,h.listMainShift)});i.length>0&&i.forEach(function(n){t.push(n.UserId)})}),$.each(t,function(t,i){$.inArray(i,n)===-1&&n.push(i)}),n};h.getMonthOfWork=function(n,t=true){var i=[],e=0,r,f,u;h.listMonth.forEach(function(n){i.push({Day:n.DistributeDate,Working:[]})});h.fullListData.forEach(function(t){var r=t.ShiftData.filter(function(i){if(i.UserId==n)return i.SalePointId=t.SalePointId,i.target=parseInt(i.DistributeDate.slice(8,10))-1,i});r.length>0&&(e+=r.length,r.forEach(function(n){i[n.target].Working.push(n)}))});r=i.filter(n=>n.Working.length==0).length;f=0;t&&(u=angular.copy(r),i.forEach(function(n){var t,i,r;if(n.Working.length>=2){t=n.Working;for(let n=1;n<t.length;n++)u>0?(t[n].ShiftTypeId=2,u--):(t[n].ShiftTypeId=3,f++),i=h.listSalePoint.filter(i=>i.Id==t[n].SalePointId)[0],r=i.listMonth[t[n].target]["objShift"+t[n].ShiftId].isShift1?1:2,i.listMonth[t[n].target]["ShiftTypeId"+r]=t[n].ShiftTypeId}}));h.listAttend.push({UserId:n,TotalShift:e,TotalAbsent:t?r:0,TotalMakeup:t?r-u:0,TotalOT:f,IsMainShift:t})};h.restartShiftType=function(){h.listSalePoint.forEach(function(n){n.listMonth.forEach(function(n){n.ShiftTypeId1=1;n.ShiftTypeId2=1})})};h.checkFullSchedule=function(){h.listAttend=[];h.restartShiftType();h.listMainShift=h.getShiftMain();h.fullListData=h.getSaveData();h.listExtend=h.getExtendUser();h.listMainShift.forEach(function(n){h.getMonthOfWork(n)});h.listExtend.forEach(function(n){h.getMonthOfWork(n,!1)})};h.openPopup=function(n,t={},i={},r){var o=null,f=t["objShift"+n].isShift1?1:2,c,l,e;o=t["Shift"+f]?t["Shift"+f]:i["inputShift_"+f];c=angular.copy(h.listStaff);l=baseAppPath+"/user/views/modal/";e=s.open({templateUrl:l+"shiftDetail.html"+versionTemplate,controller:"User.shiftDetail as $vm",backdrop:"static",size:"md",windowClass:"remove-modal-footer",resolve:{viewModel:{userOnShift:{name:t.name,userId:o},note:t["Note"+f],shift:n,salePointId:i.Id,distributeDate:t.DistributeDate,listStaff:c,isIntern:!0,ShiftDistributeId:r}}});e.opened.then(function(){$(document).ready(function(){$(".modal-footer").addClass("remove-modal-footer")})});e.result.then(function(){},function(r){var u,e,o,s;if(typeof r=="object"){u=i.listMonth.findIndex(n=>n.DistributeDate==t.DistributeDate);for(let t=u;t<(r.isApplyAll?i.listMonth.length:u+1);t++)i.listMonth[t]["Shift"+f]=r.UserId,i.listMonth[t]["Note"+f]=r.Note,i.listMonth[t]["ShiftTypeId"+f]=r.ShiftTypeId,e=h.listStaff.filter(n=>n.Id==r.UserId),o=h.listStatus.filter(n=>n.Id==r.ShiftTypeId)[0],e.length>0?(i.listMonth[t]["objShift"+n].isChangeData=!0,i.listMonth[t]["objShift"+n].Name=e[0].Name):i.listMonth[t]["objShift"+n].Name="Không tìm thấy người dùng",n=n==1?2:1;s=i.listMonth.findIndex(n=>n.DistributeDate==t.DistributeDate);h.checkDupValueAll()}})};h.openDayOffLeader=function(n={}){var i=baseAppPath+"/user/views/modal/",t=s.open({templateUrl:i+"addLeaderOff.html"+versionTemplate,controller:"User.addLeaderOff as $vm",backdrop:"static",size:"md",windowClass:"remove-modal-footer",resolve:{viewModel:{date:n,listLeader:h.listLeader}}});t.opened.then(function(){$(document).ready(function(){$(".modal-footer").addClass("remove-modal-footer")})});t.result.then(function(){},function(t){typeof t=="object"&&(n=angular.extend(n,t))})};h.getIdTarget=function(n,t,i){var r=h.listSalePoint[n].listMonth[i]["objShift"+t].isShift1?1:2;return h.listSalePoint[n].listMonth[i]["Shift"+r]?h.listSalePoint[n].listMonth[i]["Shift"+r]:h.listSalePoint[n]["inputShift_"+r]?h.listSalePoint[n]["inputShift_"+r]:null};h.checkDupValue=function(n,t,i){var r=h.getIdTarget(n,t,i);if(r)for(let u=n+1;u<h.listSalePoint.length;u++)if(n!=u&&(UserId=h.getIdTarget(u,t,i),UserId&&UserId==r)){h.listSalePoint[u].listMonth[i]["objShift"+t].isDup=!0;h.listSalePoint[n].listMonth[i]["objShift"+t].isDup=!0;h.listDateInMonth[i].isDup=!0;h.totalDup++;break}};h.exec=function(n,t){for(let i=0;i<h.listSalePoint.length-1;i++)h.listSalePoint[i].listMonth[t]["objShift"+n].isDup=!1;for(let i=0;i<h.listSalePoint.length-1;i++)h.checkDupValue(i,n,t)};h.checkDupValueAll=function(){h.totalDup=0;var{endDate:n}=c(h.month),n=parseInt(n.slice(8,10));for(let t=0;t<n;t++){h.listDateInMonth[t].isDup=!1;for(let n=1;n<=2;n++)h.exec(n,t)}h.checkFullSchedule()};h.initData=function(){var u,f,t,n;for(h.listMonth=[],{startDate:u,endDate:f}=c(h.month),t=u;moment(t)<=moment(f);){var n=moment(t).format("YYYY-MM-DD"),i=h.listHoliday.filter(t=>moment(t.Date).format("YYYY-MM-DD")==n),r=!1;i&&i[0]&&(r=!0);h.listMonth.push({DistributeDate:n,IsChecked:!1,IsWeekEnd:moment(n).day()==0,DateName:h.dayOfWeekVN[moment(n).day()].SName,IsHoliday:r,Tooltip:r?i[0].DateName:""});t=moment(t).add(1,"day")}h.listEvent=[];h.listSalePoint.forEach(function(n){n.inputShift_1=null;n.inputShift_2=null;var t=angular.copy(h.listMonth);t.forEach(function(n,t){n.objShift1={};n.objShift2={};n.ShiftTypeId1=1;n.ShiftTypeId2=1;n.objShift1.isShift1=t%2==1;n.objShift2.isShift1=t%2==0});n.listMonth=t});h.listDistribute=h.listDistribute.filter(n=>n.IsActive==!0);n=Enumerable.From(h.listDistribute).GroupBy(function(n){return n.SalePointId}).Select(function(n){return{ShiftDistributeId:n.source[0].ShiftDistributeId,SalePointId:n.source[0].SalePointId,ShiftMain:n.source[0].ShiftMain,Data:n.source}}).ToArray();n.length>0&&n.forEach(function(n){var i=h.listSalePoint.findIndex(t=>t.Id===n.SalePointId),t=h.listSalePoint[i];n.Data.forEach(function(n){t.listMonth.forEach(function(t){t.DistributeDate==moment(n.DistributeDate).format("YYYY-MM-DD")&&(t.ShiftDistributeId=n.ShiftDistributeId)})});n.ShiftMain&&(t.ShiftMain=JSON.parse(n.ShiftMain),t.inputShift_1=t.ShiftMain.inputShift_1,t.inputShift_2=t.ShiftMain.inputShift_2);n.Data.forEach(function(n){var f=t.listMonth.findIndex(t=>t.DistributeDate==moment(n.DistributeDate).format("YYYY-MM-DD")),i=t.listMonth[f],r=i["objShift"+n.ShiftId].isShift1?1:2,u,e;t["inputShift_"+r]!=n.UserId&&(i["Shift"+r]=n.UserId,i["ShiftTypeId"+r]=n.ShiftTypeId,i["Note"+r]=n.Note,u=h.listStaff.filter(t=>t.Id==n.UserId),e=h.listStatus.filter(t=>t.Id==n.ShiftTypeId)[0],u.length>0?(i["objShift"+n.ShiftId].isChangeData=!0,i["objShift"+n.ShiftId].ShiftDistributeId=n.ShiftDistributeId,i["objShift"+n.ShiftId].Name=u[0].Name):i["objShift"+n.ShiftId].Name="Không tìm thấy người dùng")})});h.listDateInMonth=angular.copy(h.listMonth);h.listLeader&&h.listLeader.length>0&&h.listLeader.forEach(function(n){n.DataSearch=n.Name.toUnaccent()});h.listDateOff=angular.copy(h.listMonth);h.listLeaderOff&&h.listLeaderOff.length>0&&h.listLeaderOff.forEach(function(n){var t=h.listDateOff.findIndex(t=>t.DistributeDate==moment(n.Date).format("YYYY-MM-DD"));n.Name=n.FullName;t>0&&(h.listDateOff[t]=angular.extend(h.listDateOff[t],n))})};h.initData();h.checkDateDup=function(n){var t=!1;return h.listSalePoint.forEach(function(i){(i.listMonth[n].objShift1.isDup||i.listMonth[n].objShift2.isDup)&&(t=!0)}),t};h.checkCurrentDate=function(n){var t=moment().format("YYYY-MM-DD"),i=parseInt(t.slice(8))-1,r=t.slice(0,7);return n==i&&h.month==r?!0:!1};h.checkDupValueAll();h.save=function(){h.isSaving=!0;h.totalDup==0||currentEvi!="pro"?(h.listSave=h.getSaveData(),h.distributeInfo.DistributeData=JSON.stringify(h.listSave),h.distributeInfo.AttendanceData=JSON.stringify(h.listAttend),h.listSave.length==0?(setTimeout(function(){h.isSaving=!1;t.$apply(h.isSaving)},1e3),u.warning("Chưa có thông tin để lưu")):f.updateShiftDistributeForIntern(h.distributeInfo).then(function(n){n&&n.Id>0?setTimeout(function(){u.success(n.Message);i.reload();h.isSaving=!1},1e3):(h.isSaving=!1,u.error(n.Message))})):(setTimeout(function(){h.isSaving=!1;t.$apply(h.isSaving)},1e3),u.warning("Đang có trùng ca"))};$(document).ready(function(){$(".select2-drop").css("position","sticky");$(".tooltips").append("<span><\/span>");$(".tooltips").mouseenter(function(){$(this).find("span").empty().append($(this).attr("tooltip"))});setTimeout(function(){$(".table-responsive").animate({scrollLeft:(parseInt(moment().format("DD"))-1)*200},400)},500)});h.checkFullSchedule();h.clickMonth=function(n){h.month=moment().add(n,"month").format("YYYY-MM");h.loadData()}}])}(),function(){app.controller("User.createUser",["$scope","$rootScope","$state","viewModel","sortIcon","$uibModal","dayOfWeek","userService","notificationService",function(n,t,i,r,u,f,e,o,s){var h=angular.extend(this,r);h.isSaving=!1;h.update={ActionBy:t.sessionInfo.UserId,ActionByName:t.sessionInfo.FullName,SalePointId:1};h.sendListData=[];h.save=function(){if(n.formCreate.$valid&&!h.isSaving){h.isSaving=!0;var t=[{Account:h.update.Account,Email:h.update.Email,FullName:h.update.FullName,SalePointId:h.update.SalePointId,Phone:h.update.Phone,NumberIdentity:h.update.NumberIdentityCard,BankAccount:h.update.BankAccount,Address:h.update.Address,Role:h.update.Role}];h.update.Data=JSON.stringify(t);console.log("vm.update.Data",h.update.Data);o.createUser(h.update).then(function(n){n&&n.Id>0?setTimeout(function(){s.success(n.Message);i.reload();h.isSaving=!1},1e3):(s.error(n.Message),h.isSaving=!1)})}else s.error("Vui lòng nhập đầy đủ thông tin!!!")}}])}(),function(){app.controller("User.extraPayment",["$scope","$rootScope","$state","viewModel","sortIcon","$uibModal","dayOfWeek","userService","notificationService","dayOfWeekVN","extraPaymentType",function(n,t,i,r,u,f,e,o,s,h,c){function a(n){var t=moment(n,"YYYY-MM").format("YYYY-MM-01"),i=moment(n,"YYYY-MM").endOf("month").format("YYYY-MM-DD");return{startDate:t,endDate:i}}function v(n,t){return n.SalePointId-t.SalePointId}var l=angular.extend(this,r);l.listUserAfter=[];l.check=!0;console.log("extraPaymentType",c);l.isCanChangeData=currentEvi!="pro"?!0:t.sessionInfo.UserTitleId==6||t.sessionInfo.UserTitleId==1||t.sessionInfo.UserTitleId==4;l.listMonth=[];l.dayOfWeekVN=angular.copy(h);l.month=l.params.month;l.thisMonth=moment(l.params.month,"YYYY-MM").format("MM/YYYY");l.extraPaymentType=angular.copy(c);l.loadData=function(){l.params.month=moment(l.month).format("YYYY-MM");i.go(i.current,l.params,{reload:!1,notify:!0})};l.clickMonth=function(n){l.month=moment().add(n,"month").format("YYYY-MM");l.loadData()};l.checkCurrentDate=function(n){var t=moment().format("YYYY-MM-DD"),i=parseInt(t.slice(8))-1,r=t.slice(0,7);return n==i&&l.month==r?!0:!1};l.init=function(){var n,u,i,r;for(l.listUser.sort(v),{startDate:n,endDate:u}=a(l.params.month);moment(n)<=moment(u);)i=l.listHoliday.filter(t=>moment(t.Date).format("YYYY-MM-DD")==n),r=!1,i&&i[0]&&(r=!0),l.listMonth.push({Date:n,DateName:l.dayOfWeekVN[moment(n).day()].SName,IsWeekEnd:moment(n).day()==0,DataInfo:[],IsHoliday:r,Tooltip:r?i[0].DateName:""}),n=moment(n,"YYYY-MM-DD").add(1,"day").format("YYYY-MM-DD");l.listUser&&l.listUser.length>0&&(l.listUser=l.listUser.filter(n=>n.UserTitleId==4||n.UserTitleId==5),l.listUser.forEach(function(n){n.listMonth=angular.copy(l.listMonth);n.listSum=angular.copy(l.extraPaymentType);n.sum=0;var t=l.listData.filter(t=>t.UserId==n.UserId);t&&t.length>0&&(t.forEach(function(t){var r=parseInt(moment(t.Date).format("DD"))-1,i;try{i=l.extraPaymentType.findIndex(n=>n.TransactionTypeId==t.TransactionTypeId);t.extraPaymentType=l.extraPaymentType[i];n.listSum[i].Sum+=t.Price;t.extraPaymentType.IsSum?n.sum+=t.Price:n.sum-=t.Price}catch(u){}n.listMonth[r].DataInfo.push(t)}),console.log("...",n))}));t.sessionInfo.IsStaff&&(l.check=!1,l.listUser.forEach(function(n){t.sessionInfo.UserId==n.UserId&&l.listUserAfter.push(n)}))};l.openModalCreate=function(n={},t="",i,r){var e=baseAppPath+"/user/views/modal/",u=f.open({templateUrl:e+"addExtraPayment.html"+versionTemplate,controller:"User.addExtraPayment as $vm",backdrop:"static",size:"lg",resolve:{viewModel:["$q","$uibModal","userService",function(i,r,u){var f=i.defer();return i.all([u.getListSalePointInDate({userId:n.UserId,date:t.Date})]).then(function(i){var r={listShiftActive:i[0],userInfo:n,dateInfo:t};f.resolve(r)}),f.promise}]}});u.opened.then(function(){$(document).ready(function(){$(".modal-content").addClass("w70vw");$(".modal-body").addClass("modal-body-rm")})});u.result.then(function(){},function(n){if(typeof n=="object"){l.listUser[i].listMonth[r].DataInfo.push(n);n.Price=parseInt(n.Price);var t=l.extraPaymentType.findIndex(t=>t.TransactionTypeId==n.TransactionTypeId);l.listUser[i].listSum[t].Sum+=n.Price;n.extraPaymentType.IsSum?l.listUser[i].sum+=n.Price:l.listUser[i].sum-=n.Price}})};l.openModalUpdate=function(n={},t={},i,r){var e=baseAppPath+"/user/views/modal/",u=f.open({templateUrl:e+"extraPaymentInfo.html"+versionTemplate,controller:"User.extraPaymentInfo as $vm",backdrop:"static",size:"lg",resolve:{viewModel:["$q","$uibModal","userService",function(u){var f=u.defer();return u.all([]).then(function(){console.log("model",n);console.log("list",t);console.log("index",i,r);var u={modelInfo:n,listInfo:t,isCanChangeData:l.isCanChangeData};f.resolve(u)}),f.promise}]}});u.opened.then(function(){$(document).ready(function(){$(".modal-content").addClass("w70vw");$(".modal-body").addClass("modal-body-rm")})});u.result.then(function(){},function(n){if(typeof n=="object"){var u=n.TransactionId,f=l.listUser[i].listMonth[r].DataInfo.findIndex(n=>n.TransactionId==u),t=angular.copy(l.listUser[i].listMonth[r].DataInfo[f]),e=l.extraPaymentType.findIndex(n=>n.TransactionTypeId==t.TransactionTypeId);l.listUser[i].listSum[e].Sum-=t.Price;t.extraPaymentType.IsSum?l.listUser[i].sum-=t.Price:l.listUser[i].sum+=t.Price;l.listUser[i].listMonth[r].DataInfo=l.listUser[i].listMonth[r].DataInfo.filter(n=>n.TransactionId!=u)}});event.stopPropagation()};l.init();console.log("listUserAfter",l.listUser);$(document).ready(function(){setTimeout(function(){$(".table-responsive").animate({scrollLeft:(parseInt(moment().format("DD"))-1)*$(window).width()*.12},400)},500);$(".tooltips").append("<span><\/span>");$(".tooltips").mouseenter(function(){$(this).find("span").empty().append($(this).attr("tooltip"))})})}])}(),function(){app.controller("User.holidaySchedule",["$scope","$rootScope","$state","viewModel","notificationService","userService","$uibModal",function(n,t,i,r,u,f,e){var o=angular.extend(this,r),s,h;o.init=function(){o.listHoliday.forEach(function(n){n.start=moment(n.Date).format("YYYY-MM-DD");n.end=moment(n.Date).add(1,"days").format("YYYY-MM-DD");n.title=n.DateName;n.id=n.EventDateId});console.log("vm.listHoliday",o.listHoliday)};o.init();o.submitSearch=function(n){i.go(i.current,{month:moment(n).format("YYYY-MM")},{reload:!1,notify:!0})};s=document.getElementById("calendar");h=new FullCalendar.Calendar(s,{schedulerLicenseKey:"GPL-My-Project-Is-Open-Source",customButtons:{thisMonthButton:{text:"Hiện tại",click:function(){o.params.month!=moment().format("YYYY-MM")&&o.submitSearch(moment())}}},headerToolbar:{left:"thisMonthButton",center:"title",right:""},locale:"vi",initialDate:o.params.month,dateClick:function(n){o.openModal(n.dateStr)},buttonIcons:!1,weekNumbers:!1,navLinks:!0,dayMaxEvents:!0,dayMaxEventRows:!0,nowIndicator:!0,now:moment().format("YYYY-MM-DD HH:mm:ss"),views:{dayGridMonth:{dayMaxEvents:4,dayMaxEventRows:4},timeGridWeek:{dayMaxEvents:4,dayMaxEventRows:4}},events:o.listHoliday,eventTimeFormat:{hour:"2-digit",minute:"2-digit",meridiem:!1,hour12:!1},eventClick:function(n){var t=n.event._def.extendedProps,i=moment(t.Date).format("YYYY-MM-DD"),r=t.DateName;o.openModal(i,r);console.log("extend",t)},progressiveEventRendering:!0});$(document).ready(function(){setTimeout(function(){h.render();$(".fc-daygrid-event.fc-daygrid-block-event").addClass("custom-height");$(".fc-event-title.fc-sticky").addClass("custom-text")},500)});o.openModal=function(n,t=""){var o=moment(moment().format("YYYY-MM-DD")).diff(moment(n,"YYYY-MM-DD"))<=0,f,r;o?(f=baseAppPath+"/user/views/modal/",r=e.open({templateUrl:f+"addHoliday.html"+versionTemplate,controller:"User.addHoliday as $vm",backdrop:"static",size:"lg",resolve:{viewModel:["$q","$uibModal","userService",function(i){var r=i.defer();return i.all([]).then(function(){var i={Date:n,HolidayName:angular.copy(t),isCreate:t==""};r.resolve(i)}),r.promise}]}}),r.opened.then(function(){$(document).ready(function(){$(".modal-footer").addClass("remove-modal-footer");$(document).ready(function(){$(".modal-body").addClass("modal-body-rm")})})}),r.result.then(function(){},function(n){typeof n=="object"&&i.reload()})):u.warning("Không thể cập nhật ở quá khứ!!!")}}])}(),function(){app.controller("User.kpi",["$scope","$rootScope","$state","viewModel","notificationService","userService","$uibModal","dayOfWeekVN","reportService",function(n,t,i,r,u,f,e,o,s){function c(n){var t=moment(n,"YYYY-MM").format("YYYY-MM-01"),i=moment(n,"YYYY-MM").endOf("month").format("YYYY-MM-DD");return{startDate:t,endDate:i}}var h=angular.extend(this,r);h.isSaving=!1;h.listMonth=[];h.listWeek=[];h.month=h.params.month;h.thisMonth=moment(h.params.month,"YYYY-MM").format("MM/YYYY");h.dayOfWeekVN=angular.copy(o);h.SalePointID=0;h.checkStaff=t.sessionInfo.IsStaff?!0:!1;h.staffId=t.sessionInfo.IsStaff?t.sessionInfo.UserId:0;h.listTaget&&(h.listTaget.TargetKPI=JSON.parse(h.listTaget.TargetKPI),h.listTaget.TargetKPILeader=JSON.parse(h.listTaget.TargetKPILeader),h.listTaget.TargetMasterLevel=JSON.parse(h.listTaget.TargetMasterLevel),h.listTaget.TargetMasterLevelData=JSON.parse(h.listTaget.TargetMasterLevelData));h.listOfUserTitle=[{Id:5,Name:"Nhân viên",isGetSP:!1,listSelected:[],listUser:[],listKPI:h.listTaget.TargetKPI},{Id:4,Name:"Trưởng nhóm",isGetSP:!0,listSelected:[],listUser:[],listKPI:h.listTaget.TargetKPILeader},];h.returnKPIPoint=function(n,t){var i=n.filter(n=>n.minTarget<t&&t<=n.maxTarget);return i&&i.length!=0?i[0].commission:0};h.loadData=function(){h.params.month=moment(h.month).format("YYYY-MM");i.go(i.current,h.params,{reload:!1,notify:!0})};h.clickMonth=function(n){h.month=moment().add(n,"month").format("YYYY-MM");h.loadData()};h.changeTab=function(n){h.currentTab=h.listWeek.filter(t=>t.WeekId==n)[0]};h.changeUserTitle=function(n){h.CoreIndex=h.listOfUserTitle.findIndex(t=>t.Id==n);h.selectedUserTitleId=h.listOfUserTitle[h.CoreIndex]};h.listSalePointDropDown.unshift({Id:0,Name:"All"});h.changeSalePoint=function(n){h.SalePointID=n};h.onChangeValue=function(n){parseInt(n.Point)>n.MaxValue&&(n.Point=n.MaxValue)};h.getTotalUser=function(n,t,i){var u=h.listOfUserTitle[n].listUser[t].ListSalePoint[i],r={Point:0,Num:0,AVG:0};u.listWeek.forEach(function(n){var t=!0;n.Sum=0;n.check&&(n.listSelected.forEach(function(i){var u=angular.copy(i.Point*i.Coef);r.Point+=parseInt(u);n.Sum+=parseInt(u);t&&(t=!1)}),r.Num=r.Num+1)});r.Num>0&&(r.AVG=Math.round(r.Point/r.Num*100)/100);h.listOfUserTitle[n].listUser[t].ListSalePoint[i].SumInfo=r};h.init=function(){for(var{startDate:t,endDate:u}=c(h.params.month),i,n,r;moment(t)<=moment(u);)h.listMonth.push({Date:t,DateName:h.dayOfWeekVN[moment(t).day()].SName,IsWeekEnd:moment(t).day()==0,typeDate:moment(t).day()}),t=moment(t,"YYYY-MM-DD").add(1,"day").format("YYYY-MM-DD");i=1;r=1;console.log("vm.listMonth",h.listMonth);h.listMonth.forEach(function(t,u){console.log("vm.listWeek",h.listWeek.length);n||(n={},n.from=t,n.WeekId=i,n.Index=i-1,i++,n.check=!0,n.month=moment(t.Date).format("YYYY-MM"));console.log("date.typeDate ",t.typeDate);(t.typeDate==0||u==h.listMonth.length-1)&&(n.to=t,n.NameDislay=moment(n.from.Date,"YYYY-MM-DD").format("DD/MM")+" -> "+moment(n.to.Date,"YYYY-MM-DD").format("DD/MM"),h.listWeek.push(n),console.log("currentWeek",n),moment().isBetween(n.from.Date,n.to.Date)&&(r=n.WeekId),n=null)});h.listOfUserTitle.forEach(function(n,t){n.listUser=h.listUser.filter(t=>t.UserTitleId==n.Id);n.listSelected=h.listTitle.filter(t=>t.UserTitleId==n.Id);n.listSelected.forEach(function(n){n.Point=0;n.PointBK=0});var i=0;n.listUser.forEach(function(r){if(r.index=i,i+=1,r.ListSalePoint&&r.ListSalePoint.length>0)r.ListSalePoint=JSON.parse(r.ListSalePoint);else{var u=h.listData.filter(n=>n.UserId==r.UserId);r.ListSalePoint=[{SalePointId:u&&u.length>0?u[0].SalePointId:null,SalePointName:u&&u.length>0?u[0].SalePointName:""}]}r.ListSalePoint.forEach(function(i,u){i.listWeek=angular.copy(h.listWeek);i.listWeek.forEach(function(t){h.listExemptKpi.forEach(function(n){n.Month==t.month&&n.UserId==r.UserId&&n.WeekId==t.WeekId&&(t.check=n.IsSumKpi)});t.listSelected=angular.copy(n.listSelected);t.listSelected.forEach(function(n){var u=h.listData.filter(u=>u.UserId==r.UserId&&u.WeekId==t.WeekId&&u.CriteriaId==n.CriteriaId&&u.SalePointId==i.SalePointId);u&&u.length>0&&(n.Point=u[0].KPI,n.PointBK=u[0].KPI)})});h.getTotalUser(t,r.index,u)})})});h.changeTab(r);h.changeUserTitle(5)};h.init();console.log("listWeek",h.listWeek);h.getDataSave=function(){var n=[];return h.listOfUserTitle.forEach(function(t){t.listUser.forEach(function(t){t.ListSalePoint.forEach(function(i){i.listWeek.forEach(function(r){r.listSelected.forEach(function(u){parseInt(u.Point)!=u.PointBK&&n.push({UserId:t.UserId,KPI:u.Point,SalePointId:i.SalePointId,WeekId:r.WeekId,CriteriaId:u.CriteriaId,Month:moment(h.month).format("YYYY-MM")})})})})})}),n};h.update={ActionBy:t.sessionInfo.UserId,ActionByName:t.sessionInfo.FullName+" ("+t.sessionInfo.UserTitleName+")"};h.save=function(){h.isSaving=!0;var n=h.getDataSave();n!=[]?(h.update.Data=JSON.stringify(n),f.updateListKPI(h.update).then(function(n){n&&n.Id>0?setTimeout(function(){u.success(n.Message);i.reload();h.isSaving=!1},1e3):(u.warning(n.Message),h.isSaving=!1)})):(u.warning("Chưa có thay đổi"),h.isSaving=!1)};h.checkAll=function(n,t,i,r){h.dataUpdate={UserId:n,WeekId:t,Month:i,isdeleted:r};h.IsChecked=!h.IsChecked;s.updateIsSumKpi(h.dataUpdate)}}])}(),function(){app.controller("User.manage",["$scope","$rootScope","$state","viewModel","notificationService","userService","$uibModal",function(n,t,i,r,u,f,e){var o=angular.extend(this,r);o.tabName=[{Id:1,Name:"Nhân viên bán hàng"},{Id:2,Name:"Trưởng nhóm"},{Id:3,Name:"Quản lý nhân sự"},{Id:4,Name:"Nhân viên đã nghỉ việc"}];o.listUser.forEach(n=>{var t=o.listSalePoint.filter(t=>t.Id==n.SalePointId);n.SalePointName=t&&t.length>0&&t[0].Name;n.SalePointName==!1&&(n.SalePointName="")});console.log("vm.listUser: ",o.listUser);o.curTab=1;o.listUserBK=o.listUser.filter(n=>n.UserTitleId==5&&n.IsActive==!0);o.changeTab=function(n){o.curTab=n;n==1?o.listUserBK=o.listUser.filter(n=>n.UserTitleId==5&&n.IsActive==!0):n==2?o.listUserBK=o.listUser.filter(n=>n.UserTitleId==4&&n.IsActive==!0):n==3?o.listUserBK=o.listUser.filter(n=>n.UserTitleId==6&&n.IsActive==!0):n==4&&(o.listUserBK=o.listUser.filter(n=>n.UserTitleId==5&&n.IsActive==!1))};o.openModal=function(n={}){var r=baseAppPath+"/user/views/modal/",t=e.open({templateUrl:r+"updateInfo.html"+versionTemplate,controller:"User.updateInfo as $vm",backdrop:"static",size:"lg",resolve:{viewModel:["$q","$uibModal","userService","ddlService",function(t,i,r,u){var f=t.defer(),e=angular.copy(n);return t.all([u.salePointDDL()]).then(function(n){var t={userInfo:e,listSalePoint:n[0]};f.resolve(t)}),f.promise}]}});t.opened.then(function(){$(document).ready(function(){$(".modal-footer").addClass("remove-modal-footer")})});t.result.then(function(){},function(n){typeof n=="object"&&i.reload()})}}])}(),function(){app.controller("User.manageLeaderOff",["$scope","$rootScope","$state","viewModel","notificationService","userService","$uibModal","salepointService",function(n,t,i,r,u,f,e,o){var s=angular.extend(this,r);if(s.isSaving=!1,s.listSalePoint.forEach(function(n){n.SalePointId=n.Id;n.SalePointName=n.Name}),s.listLeader){try{s.listData=JSON.parse(s.listLeader[0].GroupSalePointData);s.listData.forEach(function(n){n.SalePointIds=n.SalePointIds&&JSON.parse(n.SalePointIds)?JSON.parse(n.SalePointIds):[]})}catch(h){s.listData=[]}try{s.listAttendent=JSON.parse(s.listLeader[0].LeaderAttendentData)}catch(h){s.listAttendent=[]}}s.listSalePoint&&s.listSalePoint.length>0&&s.listSalePoint.sort((n,t)=>n.SalePointId-t.SalePointId);s.listAttendent&&s.listAttendent.length>0?s.maxOption=s.listAttendent.sort((n,t)=>n.TriggerSalePoint-t.TriggerSalePoint)[s.listAttendent.length-1].TriggerSalePoint:(s.listAttendent=[],s.maxOption=0);s.pushUser=function(){s.listUser.forEach(function(n){var t=s.listAttendent.findIndex(t=>t.UserId==n.UserId);t<0?(s.maxOption+=1,s.listAttendent.push({UserId:n.UserId,FullName:n.FullName,TriggerSalePoint:s.maxOption})):s.listAttendent[t].FullName=n.FullName});s.listAttendent.forEach(function(n){n.ListUser=angular.copy(s.listUser);n.ListUser.forEach(function(t){var i=s.listData.findIndex(i=>i.UserId==t.UserId&&i.Option==n.TriggerSalePoint);t.SalePointIds=i>=0?angular.copy(s.listData[i].SalePointIds):[]})})};s.changeTab=function(n){s.currentTab=s.listAttendent.filter(t=>t.TriggerSalePoint==n)[0];s.currentTabId=s.listAttendent.findIndex(t=>t.TriggerSalePoint==n)};s.CheckIn=function(n,t){return n.includes(t)};s.checkLengthSP=function(n){var t=0;return s.listAttendent[s.currentTabId].ListUser.forEach(function(i){i.SalePointIds.includes(n)&&i.UserId!=s.currentTab.UserId&&t++}),t};s.removeArr=function(n){for(var t,i=arguments,r=i.length,u;r>1&&n.length;)for(t=i[--r];(u=n.indexOf(t))!==-1;)n.splice(u,1);return n};s.addArr=function(n,t){s.checkLengthSP(t)>=1?u.warning("Không thể chọn 2 trưởng nhóm cho 1 điểm bán"):n.push(t)};s.init=function(){s.listAttendent.unshift({UserId:0,FullName:"(none)",TriggerSalePoint:0});s.pushUser();s.changeTab(0)};s.init();s.getDataSave=function(){var n=[];return s.listAttendent.forEach(function(t){t.ListUser.forEach(function(i,r){i.UserId!=t.UserId?n.push({UserId:i.UserId,Option:t.TriggerSalePoint,SalePointIds:i.SalePointIds}):n.push({UserId:i.UserId,Option:t.TriggerSalePoint,SalePointIds:s.listAttendent[0].ListUser[r].SalePointIds})})}),n};s.update={ActionBy:t.sessionInfo.UserId,ActionByName:t.sessionInfo.FullName+" ("+t.sessionInfo.UserTitleName+")"};s.save=function(){var n,i;if(s.isSaving=!0,n=s.getDataSave(),n==[])u.warning("Không có gì để lưu"),s.isSaving=!1;else{i=[];for(let n=1;n<s.listAttendent.length;n++)i.push({UserId:s.listAttendent[n].UserId,TriggerSalePoint:s.listAttendent[n].TriggerSalePoint});s.update.Data=JSON.stringify({GroupSalePointData:n,LeaderAttendentData:i});o.updateLeaderAttendent(s.update).then(function(n){n&&n.Id>0?setTimeout(function(){u.success(n.Message);s.isSaving=!1;setTimeout(function(){t.$apply(s.isSaving)},100)},0):(u.warning(n.Message),s.isSaving=!1,setTimeout(function(){t.$apply(s.isSaving)},100))})}console.log("temp",n)};console.log("listAttendent",s.listAttendent)}])}(),function(){app.controller("User.addExtraPayment",["$scope","$rootScope","$state","viewModel","$uibModalInstance","shiftStatus","userService","notificationService","extraPaymentType","ddlService","salepointService",function(n,t,i,r,u,f,e,o,s,h,c){var l=angular.extend(this,r);l.isSaving=!1;l.extraPaymentType=angular.copy(s);l.currentTab=l.extraPaymentType[0];l.saveInfo={};console.log("vm.extraPaymentType",l.extraPaymentType);l.changeTab=function(n,t=0){l.currentTab=l.extraPaymentType.filter(t=>t.Id==n)[0];h.getTypeNameDDL({transactionTypeId:t}).then(function(n){l.listSelected=n;try{l.saveInfo.typeTransactionId=n[0];l.saveInfo.typeTransactionId.Price>0?(l.saveInfo.PriceDisplay=l.saveInfo.typeTransactionId.Price.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","),l.saveInfo.isChangePrice=!1):(l.saveInfo.isChangePrice=!0,l.saveInfo.PriceDisplay=0)}catch(t){l.saveInfo.typeTransactionId=null;l.saveInfo.PriceDisplay=0;l.saveInfo.isChangePrice=!0}})};l.changeTab(1,6);l.changePrice=function(n){l.saveInfo.SelectPrice=n;l.saveInfo.PriceDisplay=n.Price.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")};l.changeShiftDistribute=function(n){l.saveInfo.SelectDistribute=n};l.update={ActionBy:t.sessionInfo.UserId,ActionType:1,ActionByName:t.sessionInfo.FullName+" ("+t.sessionInfo.UserTitleName+")"};l.getSaveData=function(){return[{Date:l.dateInfo.Date,Price:l.saveInfo.PriceDisplay.replace(/,/g,""),UserId:l.userInfo.UserId,ShiftDistributeId:l.saveInfo.ShiftDistributeId?l.saveInfo.ShiftDistributeId.ShiftDistributeId:null,SalePointId:l.saveInfo.ShiftDistributeId?l.saveInfo.ShiftDistributeId.SalePointId:null,TransactionTypeId:l.saveInfo.typeTransactionId?l.saveInfo.typeTransactionId.TransactionTypeId:null,TypeNameId:l.saveInfo.typeTransactionId?l.saveInfo.typeTransactionId.TypeNameId:null,TypeName:l.saveInfo.typeTransactionId.TypeName,Note:l.saveInfo.Note}]};l.save=function(){l.isSaving=!0;l.update.TransactionTypeId=l.saveInfo.typeTransactionId?l.saveInfo.typeTransactionId.TransactionTypeId:null;l.update.Data=JSON.stringify(l.getSaveData());c.insertUpdateTransaction(l.update).then(function(n){n&&n.Id>0?setTimeout(function(){o.success(n.Message);l.isSaving=!1;var t={ActionBy:l.update.ActionBy,ActionByName:l.update.ActionByName,ActionDate:moment(),Date:l.dateInfo.Date,Note:l.saveInfo.Note,Price:l.saveInfo.PriceDisplay.replace(/,/g,""),SalePointId:l.saveInfo.ShiftDistributeId?l.saveInfo.ShiftDistributeId.SalePointId:null,TransactionId:n.Id,TransactionTypeId:l.saveInfo.typeTransactionId?l.saveInfo.typeTransactionId.TransactionTypeId:null,UserId:l.userInfo.UserId,TypeNameId:l.saveInfo.typeTransactionId.TypeNameId,TypeName:l.saveInfo.Name,extraPaymentType:s.filter(n=>n.TransactionTypeId==l.saveInfo.typeTransactionId.TransactionTypeId)[0]};u.dismiss(t)},1e3):l.isSaving=!1})};l.close=function(){u.close()}}])}(),function(){app.controller("User.addHoliday",["$scope","$rootScope","$state","viewModel","$uibModalInstance","shiftStatus","userService","notificationService",function(n,t,i,r,u,f,e,o){var s=angular.extend(this,r);s.update={ActionBy:t.sessionInfo.UserId,ActionByName:t.sessionInfo.FullName};s.dayDisplay=moment(s.Date).format("DD/MM/YYYY");s.save=function(n=false){if(s.isSaving=!0,s.HolidayName&&s.HolidayName.length>0){var t=[{Date:s.Date,Note:s.HolidayName,IsDeleted:n}];s.update.Data=JSON.stringify(t);e.updateListEventDate(s.update).then(function(n){n&&n.Id>0?setTimeout(function(){o.success(n.Message);i.reload();s.isSaving=!1},1e3):(o.warning(n.Message),s.isSaving=!1)})}else o.warning("Chưa nhập thông tin ngày lễ"),s.isSaving=!1};s.close=function(){u.close()}}])}(),function(){app.controller("User.addLeaderOff",["$scope","$rootScope","$state","viewModel","$uibModalInstance","shiftStatus","userService","notificationService","salepointService",function(n,t,i,r,u,f,e,o,s){var h=angular.extend(this,r),c;h.date.DateDisplay=moment(h.date.DistributeDate,"YYYY-MM-DD").format("DD/MM/YYYY");h.update={ActionBy:t.sessionInfo.UserId,ActionByName:t.sessionInfo.FullName,ActionType:1};h.date&&h.date.UserId&&(c=h.listLeader.findIndex(n=>n.Id==h.date.UserId),c>=0&&(h.selectedLeader=h.listLeader[c]),h.Note=h.date.Note);h.listLeader.unshift({Id:-1,Name:""});h.isSaving=!1;h.save=function(){h.isSaving=!0;h.selectedLeader&&h.selectedLeader.Id?(h.update.Data=JSON.stringify([{WorkingDate:h.date.DistributeDate,UserId:h.selectedLeader.Id,Note:h.Note}]),s.updateDateOffOfLeader(h.update).then(function(n){n&&n.Id>0?(h.isSaving=!1,setTimeout(function(){o.success(n.Message);u.dismiss({UserId:h.selectedLeader.Id,Name:h.selectedLeader.Name,Note:h.Note})},0)):(o.warning(n.Message),h.isSaving=!1)}),h.isSaving=!1):(o.warning("Something wrong"),h.isSaving=!1)};h.close=function(){u.close()}}])}(),function(){app.controller("User.extraPaymentInfo",["$scope","$rootScope","$state","viewModel","$uibModalInstance","shiftStatus","userService","notificationService","extraPaymentType","ddlService","salepointService",function(n,t,i,r,u,f,e,o,s,h,c){var l=angular.extend(this,r);l.isSaving=!1;l.extraPaymentType=angular.copy(s);l.updateData={ActionBy:t.sessionInfo.UserId,ActionByName:t.sessionInfo.FullName+" ("+t.sessionInfo.UserTitleName+")",ActionType:3,Data:JSON.stringify([{TransactionId:l.modelInfo.TransactionId}])};l.save=function(){l.isSaving=!0;c.insertUpdateTransaction(l.updateData).then(function(n){n&&n.Id>0?setTimeout(function(){o.success(n.Message);u.dismiss({TransactionId:l.modelInfo.TransactionId});l.isSaving=!1},1e3):l.isSaving=!1})};l.close=function(){u.close()}}])}(),function(){app.controller("User.shiftDetail",["$scope","$rootScope","$state","viewModel","$uibModalInstance","shiftStatus","userService","notificationService",function(n,t,i,r,u,f,e,o){var s=angular.extend(this,r);s.isApplyAll=!0;s.SaveInfo={ActionBy:t.sessionInfo.UserId,ActionByName:t.sessionInfo.FullName+" ("+t.sessionInfo.UserTitleName+")",SalePointId:s.salePointId,DistributeDate:s.distributeDate,ShiftId:s.shift};s.selectedStaff=null;s.close=function(){u.close()};s.onPickStaff=function(n){s.selectedStaff=n};s.init=function(){s.listStatus=angular.copy(f);var n=s.listStaff.filter(n=>n.Id==s.userOnShift.userId);s.userOnShift.name=n.length>0?n[0].Name:"Không tìm thấy người dùng";s.listStaff=s.isIntern?s.listStaff.filter(n=>n.Id!==s.userOnShift.userId&&n.IsIntern):s.listStaff.filter(n=>n.Id!==s.userOnShift.userId);s.listStaff.unshift({Id:-1,Name:""})};s.init();console.log("vm.listStaff",s.listStaff);s.changeCheck=function(){console.log("vm.isApplyAll",s.isApplyAll)};s.save=function(){s.SaveInfo.Note=s.note;s.SaveInfo.isApplyAll=s.isApplyAll;s.SaveInfo.ShiftTypeId=1;s.SaveInfo.UserId=s.selectedStaff.Id;u.dismiss(s.SaveInfo);console.log("vm.SaveInfo",s.SaveInfo)};s.deleteInter=function(){var n=bootbox.confirm({message:' <i class="fa fa-times fa-lg" aria-hidden="true" style="color: red;"><\/i> Bạn muốn <strong>xóa<\/strong> lịch thử việc?',buttons:{confirm:{label:"Đồng ý",className:"btn-success"},cancel:{label:"Huỷ",className:"btn-secondary"}},callback:function(n){setTimeout(function(){$(".modal-md").css("display","block")},500);n&&(dataDelete={ShiftDistributeId:s.ShiftDistributeId},e.deleteDistributeForIntern(dataDelete).then(n=>{n&&n.Id>0?(o.success(n.Message),i.go(i.current,{},{reload:!0,notify:!0})):o.error(n.Message)}))}});n.init(function(){setTimeout(function(){$(".modal-body").removeClass("modal-body");$(".modal-md").css("display","none")},0)})}}])}(),function(){app.controller("User.updateInfo",["$scope","$rootScope","$state","viewModel","$uibModalInstance","shiftStatus","userService","notificationService",function(n,t,i,r,u,f,e,o){var s=angular.extend(this,r),c="YYYY-MM-DD",h="DD/MM/YYYY";s.update=angular.extend(s.userInfo,{ActionBy:t.sessionInfo.UserId,ActionByName:t.sessionInfo.FullName});s.update.EndDate=s.update.EndDate?s.update.EndDate:"";s.update.StartDate=s.update.StartDate?s.update.StartDate:"";s.update.SalaryDisplay=s.update.BasicSalary?s.update.BasicSalary.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","):"0";s.update.EndDayDisplay=s.update.EndDate?moment(s.update.EndDate,c).format(h):moment().format(h);s.update.StartDayDisplay=s.update.StartDate?moment(s.update.StartDate,c).format(h):moment().format(h);s.checkDate=function(){try{return moment(s.update.StartDayDisplay,h).diff(moment(s.update.EndDayDisplay,h).format(c))<=0}catch(n){return!1}};s.save=function(){if(n.formCreate.$valid&&!s.isSaving){s.isSaving=!0;var r={FullName:s.update.FullName,IsActive:s.update.IsActive,BasicSalary:s.update.SalaryDisplay.replace(/\,/g,""),StartDate:moment(s.update.StartDayDisplay,h).format(c),SalePointId:s.update.SalePointId,Phone:s.update.Phone,NumberIdentity:s.update.NumberIdentity,Address:s.update.Address,BankAccount:s.update.BankAccount,IsIntern:s.update.IsIntern};s.update.IsActive||(r.EndDate=moment(s.update.EndDayDisplay,h).format(c));s.update.Data=JSON.stringify(r);e.updateUserInfo(s.update).then(function(n){n&&n.Id>0?setTimeout(function(){o.success(n.Message);i.reload();s.isSaving=!1},1e3):setTimeout(function(){o.error(n.Message);s.isSaving=!1;t.$apply(s.isSaving)},1e3)});console.log(s.update)}};s.close=function(){u.close()}}])}(),function(){app.controller("User.rolePermission",["$scope","$rootScope","$state","viewModel","sortIcon","$uibModal","dayOfWeek","userService","notificationService",function(n,t,i,r,u,f,e,o,s){var h=angular.extend(this,r),l=u,c;h.update={ActionBy:t.sessionInfo.Id,ActionByName:t.sessionInfo.FullName};h.save=function(){h.update.ListRole=JSON.stringify(h.update.ListRole);o.updatePermissionRole(h.update).then(function(n){n&&n.Id>0?(s.success(n.Message),t.connection.invoke("SendMessage","updatePermission",h.update.UserTitleId.toString()).catch(function(n){return console.error(n.toString())})):s.error(n.Message)})};h.checkAllObj=function(n,t){h.update.ListRole=[];n.forEach(function(n){h.update.ListRole.push({RoleId:n.RoleId,IsCheck:t})});h.save()};h.checkAll=function(n){$(".parent"+n).each(function(){this.checked?(h.checkAllObj(h.listTitle[n].Data,!0),$(".child"+n).each(function(){this.checked=!0})):(h.checkAllObj(h.listTitle[n].Data,!1),$(".child"+n).each(function(){this.checked=!1}))})};c=0;h.checkFull=function(n){c=0;$(".child"+n).each(function(){this.checked==!0&&c++});c<$(".child"+n).length?$(".parent"+n).prop("checked",!1):$(".parent"+n).prop("checked",!0)};h.checkItem=function(n,t){h.update.ListRole=[];var i=h.listTitle[n].Data[t];h.update.ListRole.push({RoleId:i.RoleId,IsCheck:!i.IsCheck});h.save()};h.getListRolePermission=function(n){o.getPermissionByTitle({userTitleId:n}).then(function(n){h.listTitle=n;h.listTitle=Enumerable.From(h.listTitle).GroupBy(function(n){return n.PermissionId}).Select(function(n){return{PermissionId:n.source[0].PermissionId,PermissionName:n.source[0].PermissionName,Data:n.source,IsChecked:n.source.length==n.source.filter(n=>n.IsCheck==!0).length}}).ToArray()})};h.selectedRow=0;h.rowHighilited=function(n,t){h.update.UserTitleId=t;h.selectedRow=n;h.getListRolePermission(t)};h.rowHighilited(1,2)}])}(),function(){app.controller("User.schedule",["$scope","$rootScope","$state","viewModel","sortIcon","authService","$uibModal","shiftStatus",function(n,t,i,r,u,f,e,o){var s=angular.extend(this,r),c,l,h;s.month=s.params.distributeMonth;s.thisMonth=moment(s.month,["MM-YYYY","YYYY-MM"]).format("MM-YYYY");s.loadData=function(){s.params.distributeMonth=moment(s.month).format("YYYY-MM");i.go(i.current,s.params,{reload:!1,notify:!0})};s.listStatus=angular.copy(o);s.openPopup=function(n={},t={}){var u=baseAppPath+"/user/views/modal/",r=e.open({templateUrl:u+"shiftDetail.html"+versionTemplate,controller:"User.shiftDetail as $vm",backdrop:"static",size:"md",windowClass:"remove-modal-footer",resolve:{viewModel:{userOnShift:{name:n.name,userId:n.userId},note:n.note,shift:n.shift,salePointId:n.salePointId,distributeDate:moment(t).format("YYYY-MM-DD"),listStaff:s.listStaff}}});r.opened.then(function(){$(document).ready(function(){$(".modal-footer").addClass("remove-modal-footer")})});r.result.then(function(){},function(n){typeof n=="object"&&i.reload()})};c=function(){s.listEvent=[];s.listDistribute&&s.listDistribute.length>0&&s.listDistribute.forEach(function(n){var t=s.listStaff.filter(t=>t.Id==n.UserId)[0],i=s.listStatus.filter(t=>t.Id==n.ShiftTypeId)[0],r;t&&(r={start:moment(n.DistributeDate).format("YYYY-MM-DD"),end:moment(n.DistributeDate).format("YYYY-MM-DD"),title:(t?t.Name:"Nhân viên không tồn tại")+(i?i.SName:""),shift:n.ShiftId,userId:n.UserId,name:t?t.Name:"Nhân viên không tồn tại"+(i?i.SName:""),salePointId:n.SalePointId,note:n.Note},s.listEvent.push(r))})};c();l=document.getElementById("calendar");h=new FullCalendar.Calendar(l,{schedulerLicenseKey:"CC-Attribution-NonCommercial-NoDerivatives",customButtons:{thisMonthButton:{text:"This month",click:function(){var n=moment().format("YYYY-MM");n!=s.params.month&&h.today()}}},headerToolbar:{left:"thisMonthButton",center:"title",right:""},locale:"vi",initialDate:s.month,buttonIcons:!1,weekNumbers:!1,navLinks:!0,dayMaxEvents:!0,dayMaxEventRows:!0,nowIndicator:!0,now:moment().format("YYYY-MM-DD HH:mm:ss"),views:{dayGridMonth:{dayMaxEvents:4,dayMaxEventRows:4},timeGridWeek:{dayMaxEvents:4,dayMaxEventRows:4}},events:s.listEvent,eventOrder:["shift"],eventTimeFormat:{hour:"2-digit",minute:"2-digit",meridiem:!1,hour12:!1},eventClick:function(){},eventClassNames:function(n){return n.event.extendedProps.shift==1?["morning-shift"]:["evening-shift"]},progressiveEventRendering:!0});$(document).ready(function(){setTimeout(function(){h.render();$(".fc-thisMonthButton-button").html("Tháng này");$(".fc-toolbar-title").html($(".fc-toolbar-title").html().replace("t","T"));$(".fc-col-header-cell-cushion").css("padding","0");$(".fc-col-header-cell-cushion").css("font-size","14px");$(".fc-thisMonthButton-button").click(function(){s.month=moment();s.loadData()})},500)});console.log("listEvent: ",s.listEvent)}])}(),function(){app.controller("User.staffSchedule",["$scope","$rootScope","$state","viewModel","sortIcon","$uibModal","dayOfWeek","dayOfWeekVN","shiftStatus",function(n,t,i,r,u,f,e,o,s){var h=angular.extend(this,r),l,a,v,c;h.month=h.params.distributeMonth;h.thisMonth=moment(h.month,["MM-YYYY","YYYY-MM"]).format("MM-YYYY");l=function(n){if(moment().format("DD")==moment(n).format("DD")){if(moment().format("HH:mm")>"21:00")return[1,2];if(moment().format("HH:mm")>"13: 30")return[1]}return[]};h.totalShiftInMonth=h.listDistribute.length;h.totalShiftToCurrent=h.listDistribute.filter(n=>moment(n.DistributeDate).diff(moment().add(-1,"days"))<0||l(n.DistributeDate).includes(n.ShiftId)).length;h.loadData=function(){h.params.distributeMonth=moment(h.month).format("YYYY-MM");i.go(i.current,h.params,{reload:!1,notify:!0})};h.listStatus=angular.copy(s);h.openPopup=function(n={},t={}){var u=baseAppPath+"/user/views/modal/",r=f.open({templateUrl:u+"shiftDetail.html"+versionTemplate,controller:"User.shiftDetail as $vm",backdrop:"static",size:"md",windowClass:"remove-modal-footer",resolve:{viewModel:{userOnShift:{name:n.name,userId:n.userId},note:n.note,shift:n.shift,salePointId:n.salePointId,distributeDate:moment(t).format("YYYY-MM-DD"),listStaff:h.listStaff}}});r.opened.then(function(){$(document).ready(function(){$(".modal-footer").addClass("remove-modal-footer")})});r.result.then(function(){},function(n){typeof n=="object"&&i.reload()})};a=function(){h.listEvent=[];h.listDistribute&&h.listDistribute.length>0&&h.listDistribute.forEach(function(n){var t=h.listStaff.filter(t=>t.Id==n.UserId)[0],i=h.listStatus.filter(t=>t.Id==n.ShiftTypeId)[0],r;t&&(r={start:moment(n.DistributeDate).format("YYYY-MM-DD"),end:moment(n.DistributeDate).format("YYYY-MM-DD"),title:n.SalePointName+" - "+(t?t.Name:"Nhân viên không tồn tại"),shift:n.ShiftId,userId:n.UserId,name:t?t.Name+n.SalePointName:"Nhân viên không tồn tại"+(i?i.SName:""),salePointId:n.SalePointId,note:n.Note},h.listEvent.push(r))})};a();v=document.getElementById("calendar");c=new FullCalendar.Calendar(v,{schedulerLicenseKey:"CC-Attribution-NonCommercial-NoDerivatives",customButtons:{thisMonthButton:{text:"This month",click:function(){var n=moment().format("YYYY-MM");n!=h.params.month&&c.today()}}},headerToolbar:{left:"thisMonthButton",center:"title",right:""},locale:"vi",initialDate:h.month,buttonIcons:!1,weekNumbers:!1,navLinks:!0,dayMaxEvents:!0,dayMaxEventRows:!0,nowIndicator:!0,now:moment().format("YYYY-MM-DD HH:mm:ss"),views:{dayGridMonth:{dayMaxEvents:4,dayMaxEventRows:4},timeGridWeek:{dayMaxEvents:4,dayMaxEventRows:4}},events:h.listEvent,eventOrder:["shift"],eventTimeFormat:{hour:"2-digit",minute:"2-digit",meridiem:!1,hour12:!1},eventClick:function(){},eventClassNames:function(n){return n.event.extendedProps.shift==1?["morning-shift"]:["evening-shift"]},progressiveEventRendering:!0});$(document).ready(function(){setTimeout(function(){c.render();$(".fc-thisMonthButton-button").html("Tháng này");$(".fc-toolbar-title").html($(".fc-toolbar-title").html().replace("t","T"));$(".fc-thisMonthButton-button").click(function(){h.month=moment();h.loadData()})},500)})}])}(),function(){app.controller("User.storeShiftManage",["$scope","$rootScope","$state","viewModel","sortIcon","$uibModal","dayOfWeek","dayOfWeekVN",function(n,t,i,r,u,f,e,o){var s=angular.extend(this,r),h=["DD/MM/YYYY","YYYY-MM-DD","DD-MM-YYYY"],c="YYYY-MM-DD";s.params.day=moment(s.params.day,h).format("DD-MM-YYYY");s.listForManager=[];t.sessionInfo.IsManager?(console.log("vào đây 1"),s.listStore=Enumerable.From(s.listSalePoint).GroupBy(function(n){return n.SalePointId}).Select(function(n){return{ManagerId:n.source[0].ManagerId,ManagerName:n.source[0].ManagerName,SalePointName:n.source[0].SalePointName,SalePointId:n.source[0].SalePointId,ShiftUser1Id:n.source[0].UserId,ShiftUser1Name:n.source[0].FullName,ShiftUser2Id:n.source[1].UserId,ShiftUser2Name:n.source[1].FullName,DistributeMonth:moment(s.params.days).format("YYYY-MM")}}).ToArray(),s.listStore.forEach(function(n){n.ManagerId==t.sessionInfo.UserId&&s.listForManager.push(n)})):(console.log("vào đây 2"),s.listStore=Enumerable.From(s.listSalePoint).GroupBy(function(n){return n.SalePointId}).Select(function(n){return{ManagerId:n.source[0].ManagerId,ManagerName:n.source[0].ManagerName,SalePointName:n.source[0].SalePointName,SalePointId:n.source[0].SalePointId,ShiftUser1Id:n.source[0].UserId,ShiftUser1Name:n.source[0].FullName,ShiftUser2Id:n.source[1].UserId,ShiftUser2Name:n.source[1].FullName,DistributeMonth:moment(s.params.days).format("YYYY-MM")}}).ToArray(),s.listForManager=s.listStore);console.log(" vm.listForManager",s.listForManager);console.log("vm.listStore1: ",s.listStore1);console.log("vm.listSalePoint",s.listSalePoint);s.dayDisplay=o[moment(moment(s.params.day,h)).day()].Name+", "+s.params.day;s.changeDate=function(){i.go(i.current,{day:moment(s.params.day,h).format(c)},{reload:!0,notify:!0})};s.clickToday=function(n=0){s.params.day=moment().add(n,"days").format("YYYY-MM-DD");s.changeDate()};s.dayOfWeekVN=angular.copy(o)}])}(),function(){app.controller("User.targetTable",["$scope","$rootScope","$state","viewModel","notificationService","userService","$uibModal",function(n,t,i,r,u,f){var e=angular.extend(this,r);e.saving={ActionType:2,UserRoleId:t.sessionInfo.UserRoleId,ActionBy:t.sessionInfo.UserId,ActionByName:t.sessionInfo.FullName};n.numToCurrency=function(n){return n?n.toString().replace(/\B(?=(\d{3})+(?!\d))/g,","):""};e.targetLottery=JSON.parse(e.data.TargetLottery);e.responsibilityLottery=JSON.parse(e.data.ResponsibilityLottery);e.targetVietlott=JSON.parse(e.data.TargetVietlott);e.targetKPI=JSON.parse(e.data.TargetKPI);e.targetLottery.forEach(function(n){n.minTarget=n.minTarget.toLocaleString("en-US");n.commission=n.commission.toLocaleString("en-US");n.maxTarget=n.maxTarget.toLocaleString("en-US")});e.responsibilityLottery.forEach(function(n){n.minTarget=n.minTarget.toLocaleString("en-US");n.commission=n.commission.toLocaleString("en-US");n.maxTarget=n.maxTarget.toLocaleString("en-US")});e.targetVietlott.forEach(function(n){n.minTarget=n.minTarget.toLocaleString("en-US");n.commission=n.commission.toLocaleString("en-US");n.maxTarget=n.maxTarget.toLocaleString("en-US")});e.changeTab=function(n){e.view=n;console.log("vm view",e.view)};e.changeTab("target_lottery");e.saveChanges=function(){e.view=="target_lottery"&&(e.targetLottery.forEach(function(n){n.minTarget=n.minTarget.replace(/,/g,"");n.commission=n.commission.toString().replaceAll(",","");n.maxTarget=n.maxTarget.toString().replaceAll(",","")}),e.saving.Data=JSON.stringify(e.targetLottery));e.view=="responsibility_lottery"&&(console.log("vm.responsibilityLotteryforEach",e.responsibilityLotteryforEach),e.responsibilityLottery.forEach(function(n){n.minTarget=n.minTarget.replace(/,/g,"");n.commission=n.commission.toString().replaceAll(",","");n.maxTarget=n.maxTarget.toString().replaceAll(",","")}),e.saving.Data=JSON.stringify(e.responsibilityLottery));e.view=="target_vietlott"&&(e.targetVietlott.forEach(function(n){n.minTarget=n.minTarget.replace(/,/g,"");n.commission=n.commission.toString().replaceAll(",","");n.maxTarget=n.maxTarget.toString().replaceAll(",","")}),e.saving.Data=JSON.stringify(e.targetVietlott));e.view=="kpi"&&(e.targetKPI.forEach(function(n){n.minTarget=n.minTarget.replace(/,/g,"");n.commission=n.commission.toString().replaceAll(",","");n.maxTarget=n.maxTarget.toString().replaceAll(",","")}),e.saving.Data=JSON.stringify(e.targetKPI));f.UpdateListTarget(e.saving).then(function(n){u.success(n.Message)})}}])}(),function(){app.controller("User.workSchedule",["$scope","$rootScope","$state","viewModel","notificationService","userService","dayOfWeekVN",function(n,t,i,r,u,f,e){function s(n){var t=moment(n,"YYYY-MM").format("YYYY-MM-01"),i=moment(n,"YYYY-MM").endOf("month").format("YYYY-MM-DD");return{startDate:t,endDate:i}}var o=angular.extend(this,r);o.distributeInfo={ActionBy:t.sessionInfo.UserId,ActionByName:t.sessionInfo.FullName+" ("+t.sessionInfo.UserTitleName+")",SalePointId:o.params.salePointId};o.month=o.params.distributeMonth;o.thisMonth=moment(o.month,"YYYY-MM").format("MM-YYYY");o.listMonth=[];o.dayOfWeekVN=angular.copy(e);o.loadData=function(){o.params.distributeMonth=moment(o.month).format("YYYY-MM");i.go(i.current,o.params,{reload:!1,notify:!0})};o.initData=function(){var i,r,n,t;for(o.listMonth=[],{startDate:i,endDate:r}=s(o.month),n=i;moment(n)<=moment(r);)t=moment(n).format("YYYY-MM-DD"),o.listMonth.push({DistributeDate:t,IsChecked:!1,IsWeekEnd:moment(t).day()==0,DateName:o.dayOfWeekVN[moment(t).day()].SName}),n=moment(n).add(1,"day");o.listDistribute&&o.listDistribute.length>0&&angular.forEach(o.listMonth,function(n){angular.forEach(o.listDistribute,function(t){n.DistributeDate==moment(t.DistributeDate).format("YYYY-MM-DD")&&(n["Shift"+t.ShiftId]=t.UserId)})})};o.initData();o.isCheckApply=function(n){return o.listMonth[n].IsChecked==!0&&(!o.listMonth[n+1]||o.listMonth[n+1].IsChecked==!1)?!0:!1};o.save=function(){o.listMonth.length>0?(o.listSave=[],o.listMonth.forEach(function(n){o.listSave.push({DistributeDate:n.DistributeDate,ShiftId:1,UserId:n.Shift1});o.listSave.push({DistributeDate:n.DistributeDate,ShiftId:2,UserId:n.Shift2})}),o.distributeInfo.DistributeData=JSON.stringify(o.listSave),f.distributeShift(o.distributeInfo).then(function(n){n&&n.Id>0?u.success(n.Message):u.error(n.Message)})):u.error("Chưa chọn nhân viên nào để chia ca")};o.onClickApplyAll=function(n){var r=angular.copy(n),u=[];do u.unshift(o.listMonth[r]),r=r-1;while(r>=0&&o.listMonth[r].IsChecked==!0);for(var t=n+1,i=0,f=u.length;o.listMonth[t];)i==f?i=0:(o.listMonth[t].Shift1=u[i].Shift1,o.listMonth[t].Shift2=u[i].Shift2,o.listMonth[t].IsChecked=!1,i=i+1,t=t+1)};o.onChangeShift2=function(n,t){o.listMonth[t+1]&&(o.listMonth[t+1].Shift1=n.Shift2)}}])}(),function(){app.service("userService",["baseService",function(n){var t=n.baseUrl+"/User";this.distributeShift=function(i){var r=t+"/DistributeShift";return n.postData(r,i)};this.getDataDistributeShift=function(i){var r=t+"/GetDataDistributeShift";return n.getData(r,i)};this.getHistoryScratchCardFullLog=function(i){var r=t+"/GetHistoryScratchCardFullLog";return n.getData(r,i)};this.getHistoryScratchCardLog=function(i){var r=t+"/GetHistoryScratchCardLog";return n.getData(r,i)};this.updateShift=function(i){var r=t+"/UpdateShift";return n.postData(r,i)};this.updateTotalFirst=function(i){var r=t+"/UpdateTotalFirst";return n.postData(r,i)};this.getListUser=function(i){var r=t+"/GetListUser";return n.getData(r,i)};this.getSalePointManage=function(i){var r=t+"/GetSalePointManage";return n.getData(r,i)};this.getPermissionByTitle=function(i){var r=t+"/GetPermissionByTitle";return n.getData(r,i)};this.updatePermissionRole=function(i){var r=t+"/UpdatePermissionRole";return n.postData(r,i)};this.updateTransaction=function(i){var r=t+"/UpdateTransaction";return n.postData(r,i)};this.distributeShiftMonth=function(i){var r=t+"/DistributeShiftMonth";return n.postData(r,i)};this.getDataDistributeShiftMonth=function(i){var r=t+"/GetDataDistributeShiftMonth";return n.getData(r,i)};this.getAllShiftInMonthOfOneUser=function(i){var r=t+"/GetAllShiftInMonthOfOneUser";return n.getData(r,i)};this.createUser=function(i){var r=t+"/CreateUser";return n.postData(r,i)};this.updateUserInfo=function(i){var r=t+"/UpdateUserInfo";return n.postData(r,i)};this.getListEventDate=function(i){var r=t+"/GetListEventDate";return n.getData(r,i)};this.updateListEventDate=function(i){var r=t+"/UpdateListEventDate";return n.postData(r,i)};this.getListTarget=function(i){var r=t+"/GetListTarget";return n.getData(r,i)};this.updateListTarget=function(i){var r=t+"/UpdateListTarget";return n.postData(r,i)};this.updateListKPI=function(i){var r=t+"/UpdateListKPI";return n.postData(r,i)};this.updateScratchcardFullLog=function(i){var r=t+"/UpdateScratchcardFullLog";return n.postData(r,i)};this.updateScratchcardLog=function(i){var r=t+"/UpdateScratchcardLog";return n.postData(r,i)};this.getListKPIOfUser=function(i){var r=t+"/GetListKPIOfUser";return n.getData(r,i)};this.getListSalePointInDate=function(i){var r=t+"/GetListSalePointInDate";return n.getData(r,i)};this.getListAverageKPI=function(i){var r=t+"/GetListAverageKPI";return n.getData(r,i)};this.getListSalary=function(i){var r=t+"/GetListSalary";return n.getData(r,i)};this.getListOffOfLeader=function(i){var r=t+"/GetListOffOfLeader";return n.getData(r,i)};this.getListTargetMaster=function(i){var r=t+"/GetListTargetMaster";return n.getData(r,i)};this.confirmSalary=function(i){var r=t+"/ConfirmSalary";return n.postData(r,i)};this.getListFundInYear=function(i){var r=t+"/GetListFundInYear";return n.getData(r,i)};this.insertUpdateBorrow=function(i){var r=t+"/InsertUpdateBorrow";return n.postData(r,i)};this.getListBorrowForConfirm=function(i){var r=t+"/GetListBorrowForConfirm";return n.getData(r,i)};this.payBorrow=function(i){var r=t+"/PayBorrow";return n.postData(r,i)};this.getListBorrowInMonth=function(i){var r=t+"/GetListBorrowInMonth";return n.getData(r,i)};this.createManager=function(i){var r=t+"/CreateManager";return n.postData(r,i)};this.getShiftDistributeOfIntern=function(i){var r=t+"/GetShiftDistributeOfIntern";return n.getData(r,i)};this.updateShiftDistributeForIntern=function(i){var r=t+"/UpdateShiftDistributeForIntern";return n.postData(r,i)};this.updateActiveStatusForUser=function(i){var r=t+"/UpdateActiveStatusForUser";return n.postData(r,i)};this.deleteDistributeForIntern=function(i){var r=t+"/DeleteDistributeForIntern";return n.postData(r,i)};this.UpdateListTarget=function(i){var r=t+"/UpdateListTarget";return n.postData(r,i)}}])}(),function(){var n=baseAppPath+"/user/views/";routes.user={url:"/user",abstract:!0,template:"<ui-view><\/ui-view>"};routes.user.manage={url:"/manage?p&ps&userTitleId",params:{p:{value:"1",squash:!0},ps:{value:"100",squash:!0},userTitleId:{value:"",squash:!0}},templateUrl:n+"manage.html"+versionTemplate,controller:"User.manage as $vm",resolve:{viewModel:["$q","$stateParams","userService","ddlService",function(n,t,i,r){var f=n.defer(),u=angular.copy(t);return u.p=!parseInt(u.p)||parseInt(u.p)<1?1:u.p,u.ps=!parseInt(u.ps)||parseInt(u.ps)<1?20:u.ps,n.all([i.getListUser(u),r.userTitleDDL(),r.salePointDDL()]).then(function(n){var t={params:u,listUser:n[0],listUserTitle:n[1],listSalePoint:n[2]};f.resolve(t)}),f.promise}]},title:"Danh sách nhân viên"};routes.user.schedule={url:"/schedule?distributeMonth&salePointId",params:{distributeMonth:{value:"",squash:!0},salePointId:{value:"1",squash:!0}},templateUrl:n+"schedule.html"+versionTemplate,controller:"User.schedule as $vm",resolve:{viewModel:["$q","$stateParams","userService","ddlService",function(n,t,i,r){var f=n.defer(),u=angular.copy(t);return u.distributeMonth=u.distributeMonth.length>0?u.distributeMonth:moment().format("YYYY-MM"),u.isActive=!0,n.all([i.getDataDistributeShift(u),r.salePointDDL(),r.userByTitleDDL({userTitleId:5})]).then(function(n){var t={params:u,listDistribute:n[0],listSalePoint:n[1],listStaff:n[2]};f.resolve(t)}),f.promise}]},title:"Lịch theo điểm bán"};routes.user.storeShiftManage={url:"/storeShiftManage?day",params:{day:{value:"",squash:!0}},templateUrl:n+"storeShiftManage.html"+versionTemplate,controller:"User.storeShiftManage as $vm",resolve:{viewModel:["$q","$stateParams","userService","ddlService",function(n,t,i,r){var f=n.defer(),u=angular.copy(t);return u.day=u.day==""?moment().format("YYYY-MM-DD"):u.day,n.all([i.getSalePointManage({date:u.day}),r.userByTitleDDL({userTitleId:5})]).then(function(n){var t={listSalePoint:n[0],listStaff:n[1],params:u};f.resolve(t)}),f.promise}]},title:"Quản lý chi nhánh"};routes.user.workSchedule={url:"/workSchedule?distributeMonth&salePointId",params:{distributeMonth:{value:"",squash:!0},salePointId:{value:"1",squash:!0}},templateUrl:n+"workSchedule.html"+versionTemplate,controller:"User.workSchedule as $vm",resolve:{viewModel:["$q","$stateParams","userService","ddlService",function(n,t,i,r){var f=n.defer(),u=angular.copy(t);return u.distributeMonth=u.distributeMonth.length>0?u.distributeMonth:moment().format("YYYY-MM"),u.isActive=!1,n.all([i.getDataDistributeShift(u),r.salePointDDL(),r.userByTitleDDL({userTitleId:5})]).then(function(n){var t={listDistribute:n[0],listSalePoint:n[1],listStaff:n[2],params:u};f.resolve(t)}),f.promise}]},title:"Chia lịch làm việc"};routes.user.rolePermission={url:"/rolePermission",params:{},templateUrl:n+"rolePermission.html"+versionTemplate,controller:"User.rolePermission as $vm",resolve:{viewModel:["$q","$stateParams","$rootScope","userService","ddlService",function(n,t,i,r,u){var f=n.defer(),e=angular.copy(t);return n.all([u.userTitleDDL({isGetFull:!0})]).then(function(n){var t={listRole:n[0]};f.resolve(t)}),f.promise}]},title:"Phân quyền"};routes.user.checkSchedule={url:"/checkSchedule?distributeMonth",params:{distributeMonth:{value:"",squash:!0}},templateUrl:n+"checkSchedule.html"+versionTemplate,controller:"User.checkSchedule as $vm",resolve:{viewModel:["$q","$stateParams","userService","ddlService",function(n,t,i,r){var f=n.defer(),u=angular.copy(t),e,o;return console.log(u),u.distributeMonth=u.distributeMonth.length>0?u.distributeMonth:moment().format("YYYY-MM"),u.isActive=!1,e=moment(u.distributeMonth,"YYYY-MM").format("MM"),o=moment(u.distributeMonth,"YYYY-MM").format("YYYY"),n.all([i.getDataDistributeShiftMonth(u),r.salePointDDL(),r.userByTitleDDL({userTitleId:5}),i.getListEventDate({month:e,year:o}),r.userByTitleDDL({userTitleId:4}),i.getListOffOfLeader({month:u.distributeMonth}),]).then(function(n){var t={listDistribute:n[0],listSalePoint:n[1],listStaff:n[2],listHoliday:n[3],listLeader:n[4],listLeaderOff:n[5],params:u};f.resolve(t)}),f.promise}]},title:"Chia lịch làm việc"};routes.user.staffSchedule={url:"/staffSchedule?distributeMonth&userId",params:{distributeMonth:{value:"",squash:!0},userId:{value:"",squash:!0}},templateUrl:n+"staffSchedule.html"+versionTemplate,controller:"User.staffSchedule as $vm",resolve:{viewModel:["$q","$stateParams","$rootScope","userService","ddlService",function(n,t,i,r,u){var e=n.defer(),f=angular.copy(t);return f.distributeMonth=f.distributeMonth.length>0?f.distributeMonth:moment().format("YYYY-MM"),f.userId=f.userId.length>0?f.userId:i.sessionInfo.UserId.toString(),n.all([r.getAllShiftInMonthOfOneUser({month:f.distributeMonth,UserRole:f.userId}),u.salePointDDL(),u.userByTitleDDL({userTitleId:5})]).then(function(n){var t={params:f,listDistribute:n[0],listSalePoint:n[1],listStaff:n[2]};e.resolve(t)}),e.promise}]},title:"Lịch nhân viên"};routes.user.createUser={url:"/createUser",params:{},templateUrl:n+"createUser.html"+versionTemplate,controller:"User.createUser as $vm",resolve:{viewModel:["$q","$stateParams","$rootScope","userService","ddlService",function(n,t,i,r,u){var f=n.defer(),e=angular.copy(t);return n.all([u.salePointDDL()]).then(function(n){var t={params:e,listSalePoint:n[0]};f.resolve(t)}),f.promise}]},title:"Tạo người dùng"};routes.user.targetTable={url:"/targetTable",params:{},templateUrl:n+"targetTable.html"+versionTemplate,controller:"User.targetTable as $vm",resolve:{viewModel:["$q","$stateParams","$rootScope","userService","ddlService",function(n,t,i,r){var u=n.defer(),f=angular.copy(t);return n.all([r.getListTarget(),]).then(function(n){var t={params:f,data:n[0]};u.resolve(t)}),u.promise}]},title:"Bảng target"};routes.user.kpi={url:"/kpi?p&ps&month",params:{p:{value:"1",squash:!0},ps:{value:"10000",squash:!0},month:{value:"",squash:!0}},templateUrl:n+"kpi.html"+versionTemplate,controller:"User.kpi as $vm",resolve:{viewModel:["$q","$stateParams","$rootScope","userService","ddlService","salepointService","reportService",function(n,t,i,r,u,f,e){var s=n.defer(),o=angular.copy(t);return o.month=o.month&&o.month!=""?o.month:moment().format("YYYY-MM"),n.all([u.getUserDDL({date:moment(o.month,"YYYY-MM").endOf().format("YYYY-MM-DD"),userTitleId:0}),u.getCriteriaDDL({userTitleId:0}),f.getListSalePointOfLeader({date:moment(o.month,"YYYY-MM").endOf().format("YYYY-MM-DD")}),r.getListKPIOfUser({month:o.month}),r.getListTargetMaster(),u.salePointDDL(),e.getListExemptKpi({month:o.month})]).then(function(n){var t={params:o,listUser:n[0],listTitle:n[1],listSalePoint:n[2],listData:n[3],listTaget:n[4],listSalePointDropDown:n[5],listExemptKpi:n[6]};s.resolve(t)}),s.promise}]},title:"KPI"};routes.user.holidaySchedule={url:"/holidaySchedule?month",params:{month:{value:"",squash:!0}},templateUrl:n+"holidaySchedule.html"+versionTemplate,controller:"User.holidaySchedule as $vm",resolve:{viewModel:["$q","$stateParams","userService","ddlService",function(n,t,i){var u=n.defer(),r=angular.copy(t),f,e;return r.month=r.month&&r.month!=""?r.month:moment().format("YYYY-MM"),f=moment(r.month,"YYYY-MM").format("MM"),e=moment(r.month,"YYYY-MM").format("YYYY"),n.all([i.getListEventDate({month:f,year:e})]).then(function(n){var t={params:r,listHoliday:n[0]};u.resolve(t)}),u.promise}]},title:"Lịch nghỉ lễ"};routes.user.extraPayment={url:"/extraPayment?p&ps&month",params:{p:{value:"1",squash:!0},ps:{value:"10000",squash:!0},month:{value:"",squash:!0}},templateUrl:n+"extraPayment.html"+versionTemplate,controller:"User.extraPayment as $vm",resolve:{viewModel:["$q","$stateParams","userService","ddlService","salepointService",function(n,t,i,r,u){var e=n.defer(),f=angular.copy(t),o,s;return f.month=f.month&&f.month!=""?f.month:moment().format("YYYY-MM"),o=moment(f.month,"YYYY-MM").format("MM"),s=moment(f.month,"YYYY-MM").format("YYYY"),n.all([i.getListEventDate({month:o,year:s}),r.getUserDDL({date:moment(f.month,"YYYY-MM").endOf().format("YYYY-MM-DD"),userTitleId:0}),u.getListTransaction(f)]).then(function(n){var t={params:f,listHoliday:n[0],listUser:n[1],listData:n[2]};e.resolve(t)}),e.promise}]},title:"Đánh giá chuyên cần"};routes.user.manageLeaderOff={url:"/manageLeaderOff",params:{month:{value:"",squash:!0}},templateUrl:n+"manageLeaderOff.html"+versionTemplate,controller:"User.manageLeaderOff as $vm",resolve:{viewModel:["$q","$stateParams","userService","ddlService","salepointService",function(n,t,i,r,u){var e=n.defer(),f=angular.copy(t);return f.month=f.month&&f.month!=""?f.month:moment().format("YYYY-MM"),n.all([r.getUserDDL({date:moment(f.month,"YYYY-MM").endOf().format("YYYY-MM-DD"),userTitleId:4}),r.salePointDDL(),u.getListAttendentOfLeader()]).then(function(n){var t={params:f,listUser:n[0],listSalePoint:n[1],listLeader:n[2]};e.resolve(t)}),e.promise}]},title:"Trưởng nhóm nghỉ"};routes.user.checkScheduleIntern={url:"/checkScheduleIntern?distributeMonth",params:{distributeMonth:{value:"",squash:!0}},templateUrl:n+"checkScheduleIntern.html"+versionTemplate,controller:"User.checkScheduleIntern as $vm",resolve:{viewModel:["$q","$stateParams","userService","ddlService",function(n,t,i,r){var f=n.defer(),u=angular.copy(t),e,o;return console.log(u),u.distributeMonth=u.distributeMonth.length>0?u.distributeMonth:moment().format("YYYY-MM"),u.isActive=!1,e=moment(u.distributeMonth,"YYYY-MM").format("MM"),o=moment(u.distributeMonth,"YYYY-MM").format("YYYY"),n.all([i.getShiftDistributeOfIntern(u),r.salePointDDL(),r.internByTitleDDL(),i.getListEventDate({month:e,year:o}),]).then(function(n){var t={listDistribute:n[0],listSalePoint:n[1],listStaff:n[2],listHoliday:n[3],listLeader:n[4],listLeaderOff:n[5],params:u};f.resolve(t)}),f.promise}]},title:"Lịch thử việc"}}();